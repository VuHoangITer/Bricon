{% extends "admin/admin_base.html" %}

{% block page_title %}{{ title }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4><i class="bi bi-newspaper"></i> {{ title }}</h4>
    <a href="{{ url_for('admin.blogs') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Quay l·∫°i
    </a>
</div>

<div class="row">
    <!-- LEFT: Main Form -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data" id="blogForm">
                    {{ form.hidden_tag() }}

                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label">Ti√™u ƒë·ªÅ b√†i vi·∫øt *</label>
                            {{ form.title(class="form-control", id="blogTitle", placeholder="Nh·∫≠p ti√™u ƒë·ªÅ b√†i vi·∫øt") }}
                            {% if form.title.errors %}
                                <div class="text-danger small mt-1">{{ form.title.errors[0] }}</div>
                            {% endif %}
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">Slug (URL) *</label>
                            {{ form.slug(class="form-control", id="blogSlug", placeholder="tieu-de-bai-viet") }}
                            {% if form.slug.errors %}
                                <div class="text-danger small mt-1">{{ form.slug.errors[0] }}</div>
                            {% endif %}
                            <small class="text-muted">T·ª± ƒë·ªông t·ª´ ti√™u ƒë·ªÅ</small>
                        </div>

                        <div class="col-12">
                            <label class="form-label">M√¥ t·∫£ ng·∫Øn (Excerpt)</label>
                            {{ form.excerpt(class="form-control", id="blogExcerpt", rows="3", placeholder="T√≥m t·∫Øt n·ªôi dung b√†i vi·∫øt") }}
                            <small class="text-muted">T·ªëi ƒëa 200 k√Ω t·ª±</small>
                        </div>

                        <div class="col-12">
                            <label class="form-label">N·ªôi dung b√†i vi·∫øt *</label>
                            {{ form.content(class="form-control", id="editor", rows="15", placeholder="Vi·∫øt n·ªôi dung ƒë·∫ßy ƒë·ªß ·ªü ƒë√¢y...") }}
                            {% if form.content.errors %}
                                <div class="text-danger small mt-1">{{ form.content.errors[0] }}</div>
                            {% endif %}
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">H√¨nh ·∫£nh ƒë·∫°i di·ªán</label>
                            <div class="input-group">
                                {{ form.image(class="form-control", id="image") }}
                                <button type="button" class="btn btn-warning" onclick="openMediaPicker('image', 'imagePreview')">
                                    <i class="bi bi-images"></i> Ch·ªçn t·ª´ th∆∞ vi·ªán
                                </button>
                            </div>
                            <small class="text-muted">Khuy·∫øn ngh·ªã: 800x500px (Max 16MB)</small>

                            <input type="hidden" name="selected_image_path" id="selectedImagePath" value="">

                            <div class="mt-2">
                                <img id="imagePreview" src="{% if blog and blog.image %}{{ blog.image }}{% endif %}" alt="Preview" class="img-thumbnail" style="max-height: 150px; {% if not blog or not blog.image %}display: none;{% endif %}">
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">T√°c gi·∫£</label>
                            {{ form.author(class="form-control", placeholder="T√™n t√°c gi·∫£") }}
                            <small class="text-muted">ƒê·ªÉ tr·ªëng s·∫Ω l·∫•y t√™n user hi·ªán t·∫°i</small>
                        </div>

                        <!-- SEO SECTION -->
                        <div class="col-12 mt-4">
                            <hr>
                            <h5 class="text-warning mb-3">
                                <i class="bi bi-graph-up-arrow"></i> T·ªëi ∆∞u SEO
                            </h5>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Focus Keyword *</label>
                            {{ form.focus_keyword(class="form-control", id="focusKeyword", placeholder="VD: Keo d√°n g·∫°ch Bricon") }}
                            <small class="text-muted">T·ª´ kh√≥a ch√≠nh mu·ªën x·∫øp h·∫°ng tr√™n Google</small>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Meta Title (SEO Title)</label>
                            {{ form.meta_title(class="form-control", id="metaTitle", placeholder="T·ª± ƒë·ªông t·ª´ ti√™u ƒë·ªÅ n·∫øu ƒë·ªÉ tr·ªëng") }}
                            <small class="text-muted">
                                <span id="metaTitleCount">0</span>/60 k√Ω t·ª±
                                <span class="badge bg-info" id="titleStatus">T·ªëi ∆∞u: 30-60 k√Ω t·ª±</span>
                            </small>
                        </div>

                        <div class="col-12">
                            <label class="form-label">Meta Description</label>
                            {{ form.meta_description(class="form-control", rows="3", id="metaDesc", placeholder="M√¥ t·∫£ ng·∫Øn g·ªçn cho Google Search") }}
                            <small class="text-muted">
                                <span id="metaDescCount">0</span>/160 k√Ω t·ª±
                                <span class="badge bg-info" id="descStatus">T·ªëi ∆∞u: 120-160 k√Ω t·ª±</span>
                            </small>
                        </div>

                        <!-- SEO Preview -->
                        <div class="col-12">
                            <div class="card bg-light border-warning">
                                <div class="card-header bg-warning text-dark">
                                    <i class="bi bi-google"></i> Preview Google Search
                                </div>
                                <div class="card-body">
                                    <div id="seoPreview">
                                        <div class="text-primary fw-bold" style="font-size: 20px; line-height: 1.3;" id="previewTitle">
                                            Ti√™u ƒë·ªÅ b√†i vi·∫øt s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...
                                        </div>
                                        <div class="text-success" style="font-size: 14px; margin: 4px 0;">
                                            <span>tendoanhnghiep.com.vn</span> ‚Ä∫ tin-tuc ‚Ä∫ <span id="previewSlug">slug</span>
                                        </div>
                                        <div class="text-muted" style="font-size: 14px; line-height: 1.5;" id="previewDesc">
                                            M√¥ t·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                {{ form.is_featured(class="form-check-input") }}
                                <label class="form-check-label" for="{{ form.is_featured.id }}">
                                    <i class="bi bi-star"></i> ƒê√°nh d·∫•u l√† b√†i vi·∫øt n·ªïi b·∫≠t
                                </label>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                {{ form.is_active(class="form-check-input", checked=true) }}
                                <label class="form-check-label" for="{{ form.is_active.id }}">
                                    K√≠ch ho·∫°t hi·ªÉn th·ªã
                                </label>
                            </div>
                        </div>

                        <div class="col-12 mt-4">
                            {{ form.submit(class="btn btn-warning px-5") }}
                            <a href="{{ url_for('admin.blogs') }}" class="btn btn-secondary">H·ªßy</a>
                            <button type="button" class="btn btn-info ms-2" id="checkSeoBtn">
                                <i class="bi bi-search"></i> Ki·ªÉm tra SEO
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- RIGHT: SEO Score Panel -->
    <div class="col-lg-4">
        <div class="card sticky-top" style="top: 100px;">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="bi bi-speedometer2"></i> ƒêi·ªÉm SEO</h5>
            </div>
            <div class="card-body">
                <div id="seoScorePanel">
                    <!-- Loading state -->
                    <div class="text-center py-4" id="seoLoading">
                        <div class="spinner-border text-warning" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">ƒêang ph√¢n t√≠ch SEO...</p>
                    </div>

                    <!-- Score display (hidden by default) -->
                    <div id="seoResult" style="display: none;">
                        <!-- Score Circle -->
                        <div class="text-center mb-4">
                            <div class="position-relative d-inline-block">
                                <svg width="150" height="150">
                                    <circle cx="75" cy="75" r="65" fill="none" stroke="#e9ecef" stroke-width="12"></circle>
                                    <circle id="scoreCircle" cx="75" cy="75" r="65" fill="none" stroke="#ffc107" stroke-width="12"
                                            stroke-dasharray="408" stroke-dashoffset="408"
                                            style="transition: stroke-dashoffset 1s ease; transform: rotate(-90deg); transform-origin: center;">
                                    </circle>
                                </svg>
                                <div class="position-absolute top-50 start-50 translate-middle text-center">
                                    <h2 class="mb-0 fw-bold" id="scoreNumber">0</h2>
                                    <small class="text-muted">/ 100</small>
                                    <div class="mt-1">
                                        <span class="badge" id="scoreBadge">F</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Checklist -->
                        <h6 class="fw-bold mb-3">Checklist SEO:</h6>
                        <div id="seoChecklist" class="small">
                            <!-- Will be populated by JavaScript -->
                        </div>

                        <!-- Recommendations -->
                        <div id="seoRecommendations" class="mt-3">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% include 'admin/components/media_picker_modal.html' %}
{% endblock %}

{% block extra_js %}
<script>
// Auto-generate slug from title
document.querySelector('input[name="title"]').addEventListener('input', function(e) {
    const slug = e.target.value
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/ƒë/g, 'd')
        .replace(/[^a-z0-9\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-');
    document.querySelector('input[name="slug"]').value = slug;
    updateSEOPreview();
});
</script>

<!-- ==================== CKEDITOR 5 V·ªöI RESIZE ·∫¢NH B·∫∞NG CHU·ªòT ==================== -->
<script src="https://cdn.ckeditor.com/ckeditor5/43.3.1/ckeditor5.umd.js"></script>
<link rel="stylesheet" href="https://cdn.ckeditor.com/ckeditor5/43.3.1/ckeditor5.css" />

<script>
const {
    ClassicEditor,
    Essentials,
    Bold,
    Italic,
    Underline,
    Strikethrough,
    Font,
    Paragraph,
    Heading,
    Link,
    List,
    Image,
    ImageCaption,
    ImageStyle,
    ImageToolbar,
    ImageUpload,
    ImageResize,
    LinkImage,
    Table,
    TableToolbar,
    BlockQuote,
    Code,
    Alignment,
    Undo
} = CKEDITOR;

let editorInstance;

// ‚úÖ CUSTOM UPLOAD ADAPTER CLASS
class MyUploadAdapter {
    constructor(loader) {
        this.loader = loader;
    }

    upload() {
        return this.loader.file.then(file => {
            return new Promise((resolve, reject) => {
                const formData = new FormData();
                formData.append('upload', file);

                const csrfToken = document.querySelector('input[name="csrf_token"]').value;

                console.log('üöÄ Starting upload:', file.name);

                fetch('{{ url_for("admin.ckeditor_upload_image") }}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                })
                .then(response => {
                    console.log('üì° Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('üì¶ Response data:', data);

                    if (data.url) {
                        console.log('‚úÖ Upload success:', data.url);
                        resolve({ default: data.url });
                    } else if (data.error) {
                        console.error('‚ùå Upload error:', data.error.message);
                        reject(data.error.message);
                    } else {
                        console.error('‚ùå Unknown response format');
                        reject('Upload th·∫•t b·∫°i');
                    }
                })
                .catch(error => {
                    console.error('‚ùå Network error:', error);
                    reject('L·ªói k·∫øt n·ªëi: ' + error.message);
                });
            });
        });
    }

    abort() {
        console.log('‚ö†Ô∏è Upload aborted');
    }
}

// ‚úÖ PLUGIN ƒê·ªÇ ƒêƒÇNG K√ù UPLOAD ADAPTER
function MyCustomUploadAdapterPlugin(editor) {
    editor.plugins.get('FileRepository').createUploadAdapter = (loader) => {
        console.log('üîå Creating upload adapter');
        return new MyUploadAdapter(loader);
    };
}

// ‚úÖ KH·ªûI T·∫†O CKEDITOR 5
ClassicEditor
    .create(document.querySelector('#editor'), {
        plugins: [
            Essentials,
            Bold, Italic, Underline, Strikethrough,
            Font,
            Paragraph, Heading,
            Link, List,
            Image, ImageCaption, ImageStyle, ImageToolbar, ImageUpload, ImageResize, LinkImage,
            Table, TableToolbar,
            BlockQuote, Code,
            Alignment,
            Undo,
            MyCustomUploadAdapterPlugin
        ],

        toolbar: {
            items: [
                'heading', '|',
                'bold', 'italic', 'underline', 'strikethrough', '|',
                'fontSize', 'fontColor', 'fontBackgroundColor', '|',
                'link', 'bulletedList', 'numberedList', '|',
                'uploadImage', 'insertTable', 'blockQuote', 'code', '|',
                'alignment', '|',
                'undo', 'redo'
            ],
            shouldNotGroupWhenFull: true
        },

        image: {
            toolbar: [
                'imageStyle:inline',
                'imageStyle:wrapText',
                'imageStyle:breakText',
                '|',
                'toggleImageCaption',
                '|',
                'imageTextAlternative',
                '|',
                'linkImage'
            ],
            styles: [
                'full',
                'alignLeft',
                'alignCenter',
                'alignRight'
            ],
            upload: {
                types: ['jpeg', 'png', 'gif', 'webp', 'jpg']
            }
        },

        fontSize: {
            options: [
                'tiny',
                'small',
                'default',
                'big',
                'huge'
            ]
        },

        alignment: {
            options: ['left', 'center', 'right', 'justify']
        },

        table: {
            contentToolbar: [
                'tableColumn', 'tableRow', 'mergeTableCells',
                'tableProperties', 'tableCellProperties'
            ]
        },

        link: {
            decorators: {
                openInNewTab: {
                    mode: 'manual',
                    label: 'M·ªü tab m·ªõi',
                    attributes: {
                        target: '_blank',
                        rel: 'noopener noreferrer'
                    }
                }
            }
        }
    })
    .then(editor => {
        console.log('‚úÖ CKEditor 5 v·ªõi ImageResize kh·ªüi t·∫°o th√†nh c√¥ng!');
        editorInstance = editor;
        const textarea = document.querySelector('#editor');
        textarea.removeAttribute('required');

        // Check SEO when content changes
        editor.model.document.on('change:data', () => {
            debounceCheckSEO();
        });

        // Submit form handler
        document.querySelector('form').addEventListener('submit', function(e) {
            const content = editorInstance.getData().trim();
            textarea.value = content;
            if (!content) {
                e.preventDefault();
                alert('Vui l√≤ng nh·∫≠p n·ªôi dung b√†i vi·∫øt');
                editorInstance.focus();
                return false;
            }
        });
    })
    .catch(error => {
        console.error('‚ùå L·ªói kh·ªüi t·∫°o CKEditor:', error);
        alert('Kh√¥ng th·ªÉ kh·ªüi t·∫°o tr√¨nh so·∫°n th·∫£o. Vui l√≤ng refresh trang.');
    });
</script>

<!-- ‚úÖ CSS ƒê·ªÇ ·∫¢NH RESPONSIVE -->
<style>
.ck-content img {
    max-width: 100%;
    height: auto;
    cursor: pointer;
    transition: transform 0.2s;
}

.ck-content img:hover {
    transform: scale(1.02);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.ck-content figure.image {
    margin: 1em 0;
}

.ck-content figure.image img {
    margin: 0 auto;
}

.ck-content figure.image figcaption {
    text-align: center;
    font-style: italic;
    color: #666;
    padding: 0.5em;
    background: #f5f5f5;
    margin-top: 0.5em;
}

.ck-content .image-style-align-left,
.ck-content .image-style-side {
    float: left;
    margin-right: 1.5em;
    max-width: 50%;
}

.ck-content .image-style-align-right {
    float: right;
    margin-left: 1.5em;
    max-width: 50%;
}

.ck-content .image-style-align-center {
    display: block;
    margin-left: auto;
    margin-right: auto;
}
</style>

<!-- ‚úÖ TH√äM CSS ƒê·ªÇ ·∫¢NH RESPONSIVE TR√äN FRONTEND -->
<style>
/* CSS cho ·∫£nh trong CKEditor */
.ck-content img {
    max-width: 100%;
    height: auto;
    cursor: pointer;
    transition: transform 0.2s;
}

.ck-content img:hover {
    transform: scale(1.02);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

/* CSS cho figure (·∫£nh c√≥ caption) */
.ck-content figure.image {
    margin: 1em 0;
}

.ck-content figure.image img {
    margin: 0 auto;
}

.ck-content figure.image figcaption {
    text-align: center;
    font-style: italic;
    color: #666;
    padding: 0.5em;
    background: #f5f5f5;
    margin-top: 0.5em;
}

/* CSS cho ·∫£nh cƒÉn tr√°i/ph·∫£i */
.ck-content .image-style-align-left,
.ck-content .image-style-side {
    float: left;
    margin-right: 1.5em;
    max-width: 50%;
}

.ck-content .image-style-align-right {
    float: right;
    margin-left: 1.5em;
    max-width: 50%;
}

.ck-content .image-style-align-center {
    display: block;
    margin-left: auto;
    margin-right: auto;
}
</style>

<script>
// Character counters v√† SEO Preview
const metaTitle = document.getElementById('metaTitle');
const metaDesc = document.getElementById('metaDesc');
const titleInput = document.getElementById('blogTitle');
const slugInput = document.getElementById('blogSlug');
const focusKeyword = document.getElementById('focusKeyword');

function updateCharCount(input, counterId, statusId, min, max) {
    const count = input.value.length;
    const counter = document.getElementById(counterId);
    const status = document.getElementById(statusId);

    counter.textContent = count;

    if (count >= min && count <= max) {
        status.className = 'badge bg-success';
        status.textContent = 'T·ªëi ∆∞u';
    } else if (count > 0) {
        status.className = 'badge bg-warning';
        status.textContent = count < min ? 'H∆°i ng·∫Øn' : 'H∆°i d√†i';
    } else {
        status.className = 'badge bg-secondary';
        status.textContent = `T·ªëi ∆∞u: ${min}-${max} k√Ω t·ª±`;
    }
}

function updateSEOPreview() {
    const title = metaTitle.value || titleInput.value || 'Ti√™u ƒë·ªÅ b√†i vi·∫øt s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...';
    const desc = metaDesc.value || document.getElementById('blogExcerpt').value || 'M√¥ t·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...';
    const slug = slugInput.value || 'slug';

    document.getElementById('previewTitle').textContent = title;
    document.getElementById('previewDesc').textContent = desc.substring(0, 160) + (desc.length > 160 ? '...' : '');
    document.getElementById('previewSlug').textContent = slug;
}

// Event listeners
if (metaTitle) {
    metaTitle.addEventListener('input', function() {
        updateCharCount(this, 'metaTitleCount', 'titleStatus', 30, 60);
        updateSEOPreview();
        debounceCheckSEO();
    });
    updateCharCount(metaTitle, 'metaTitleCount', 'titleStatus', 30, 60);
}

if (metaDesc) {
    metaDesc.addEventListener('input', function() {
        updateCharCount(this, 'metaDescCount', 'descStatus', 120, 160);
        updateSEOPreview();
        debounceCheckSEO();
    });
    updateCharCount(metaDesc, 'metaDescCount', 'descStatus', 120, 160);
}

if (titleInput) {
    titleInput.addEventListener('input', () => {
        updateSEOPreview();
        debounceCheckSEO();
    });
}

if (slugInput) {
    slugInput.addEventListener('input', updateSEOPreview);
}

if (focusKeyword) {
    focusKeyword.addEventListener('input', debounceCheckSEO);
}

// Initial preview
updateSEOPreview();

// Debounce function
let seoCheckTimeout;
function debounceCheckSEO() {
    clearTimeout(seoCheckTimeout);
    seoCheckTimeout = setTimeout(checkSEO, 1500);
}

// Check SEO via AJAX
function checkSEO() {
    const data = {
        title: titleInput.value,
        content: editorInstance ? editorInstance.getData() : '',
        focus_keyword: focusKeyword.value,
        meta_title: metaTitle.value,
        meta_description: metaDesc.value,
        image: document.getElementById('selectedImagePath').value || ''
    };

    // Show loading
    document.getElementById('seoLoading').style.display = 'block';
    document.getElementById('seoResult').style.display = 'none';

    fetch('/admin/api/check-blog-seo', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        displaySEOResult(result);
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('seoLoading').innerHTML = '<p class="text-danger">L·ªói khi ki·ªÉm tra SEO</p>';
    });
}

function displaySEOResult(result) {
    document.getElementById('seoLoading').style.display = 'none';
    document.getElementById('seoResult').style.display = 'block';

    // Update score
    const score = result.score;
    const scoreCircle = document.getElementById('scoreCircle');
    const circumference = 408;
    const offset = circumference - (score / 100) * circumference;

    scoreCircle.style.strokeDashoffset = offset;
    scoreCircle.style.stroke = getScoreColor(result.grade_class);

    document.getElementById('scoreNumber').textContent = score;

    const badge = document.getElementById('scoreBadge');
    badge.textContent = result.grade + ' - ' + result.grade_text;
    badge.className = 'badge bg-' + result.grade_class;

    // Update checklist
    let checklistHTML = '<ul class="list-unstyled">';
    result.checklist.forEach(item => {
        const iconClass = {
            'success': 'bi-check-circle-fill text-success',
            'info': 'bi-info-circle-fill text-info',
            'warning': 'bi-exclamation-triangle-fill text-warning',
            'danger': 'bi-x-circle-fill text-danger'
        }[item[0]];

        checklistHTML += `<li class="mb-2"><i class="bi ${iconClass}"></i> ${item[1]}</li>`;
    });
    checklistHTML += '</ul>';
    document.getElementById('seoChecklist').innerHTML = checklistHTML;

    // Update recommendations
    if (result.recommendations && result.recommendations.length > 0) {
        let recHTML = '<h6 class="fw-bold text-warning mt-3">Khuy·∫øn ngh·ªã:</h6><ul class="small">';
        result.recommendations.forEach(rec => {
            recHTML += `<li class="mb-1">${rec}</li>`;
        });
        recHTML += '</ul>';
        document.getElementById('seoRecommendations').innerHTML = recHTML;
    } else {
        document.getElementById('seoRecommendations').innerHTML = '<p class="text-success small mt-3"><i class="bi bi-check-circle"></i> SEO t·ªët, kh√¥ng c√≥ khuy·∫øn ngh·ªã th√™m!</p>';
    }
}

function getScoreColor(gradeClass) {
    const colors = {
        'success': '#28a745',
        'info': '#17a2b8',
        'warning': '#ffc107',
        'danger': '#dc3545'
    };
    return colors[gradeClass] || '#6c757d';
}

// Manual check button
document.getElementById('checkSeoBtn').addEventListener('click', checkSEO);

// Auto-check on page load if editing existing blog
window.addEventListener('load', function() {
    {% if blog %}
    setTimeout(checkSEO, 500);
    {% endif %}
});
</script>
{% endblock %}